generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id             Int         @id @default(autoincrement())
  name           String      @db.VarChar(255)
  description    String?
  baseUrl        String?     @map("base_url") @db.VarChar(500)
  isActive       Boolean     @default(true) @map("is_active")

  // Login/Authentication bilgileri
  loginUrl       String?     @map("login_url") @db.VarChar(500)
  loginUsername  String?     @map("login_username") @db.VarChar(255)
  loginPassword  String?     @map("login_password") @db.VarChar(500) // Encrypted
  loginSelectors Json?       @map("login_selectors") // {usernameField, passwordField, submitButton}

  // Ek konfigürasyon
  customHeaders  Json?       @map("custom_headers")
  cookies        Json?
  viewportWidth  Int?        @map("viewport_width") @default(1920)
  viewportHeight Int?        @map("viewport_height") @default(1080)

  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  documents      Document[]
  testSuites     TestSuite[]

  @@map("projects")
}

model Agent {
  id          Int         @id @default(autoincrement())
  name        String      @db.VarChar(100)
  role        String      @db.VarChar(100)
  type        AgentType
  status      AgentStatus @default(IDLE)
  currentTask String?     @map("current_task")
  efficiency  Decimal     @default(0) @db.Decimal(5, 2)
  totalCost   Decimal     @default(0) @map("total_cost") @db.Decimal(10, 2)
  icon        String?     @db.VarChar(50)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  logs        Log[]
  testRuns    TestRun[]

  @@map("agents")
}

model TestSuite {
  id          Int        @id @default(autoincrement())
  projectId   Int        @map("project_id")
  name        String     @db.VarChar(255)
  description String?
  type        TestType
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  scenarios   Scenario[]
  testCases   TestCase[]
  testRuns    TestRun[]
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("test_suites")
}

model TestCase {
  id             Int            @id @default(autoincrement())
  suiteId        Int            @map("suite_id")
  name           String         @db.VarChar(255)
  description    String?
  steps          Json?
  expectedResult String?        @map("expected_result")
  priority       Priority       @default(MEDIUM)
  status         TestCaseStatus @default(PENDING)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  suite          TestSuite      @relation(fields: [suiteId], references: [id], onDelete: Cascade)
  testResults    TestResult[]

  @@map("test_cases")
}

model TestRun {
  id             Int          @id @default(autoincrement())
  suiteId        Int          @map("suite_id")
  agentId        Int?         @map("agent_id")
  status         RunStatus    @default(PENDING)
  startedAt      DateTime     @default(now()) @map("started_at")
  finishedAt     DateTime?    @map("finished_at")
  durationMs     Int?         @map("duration_ms")
  errorMessage   String?      @map("error_message")
  screenshotPath String?      @map("screenshot_path") @db.VarChar(500)
  videoPath      String?      @map("video_path") @db.VarChar(500)
  metadata       Json?
  logs           Log[]
  testResults    TestResult[]
  agent          Agent?       @relation(fields: [agentId], references: [id])
  suite          TestSuite    @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  @@map("test_runs")
}

model TestResult {
  id              Int       @id @default(autoincrement())
  runId           Int       @map("run_id")
  testCaseId      Int       @map("test_case_id")
  status          RunStatus
  actualResult    String?   @map("actual_result")
  errorDetails    Json?     @map("error_details")
  executionTimeMs Int?      @map("execution_time_ms")
  screenshotPath  String?   @map("screenshot_path") @db.VarChar(500)
  createdAt       DateTime  @default(now()) @map("created_at")
  run             TestRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  testCase        TestCase  @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@map("test_results")
}

model Log {
  id        Int      @id @default(autoincrement())
  runId     Int?     @map("run_id")
  agentId   Int?     @map("agent_id")
  level     LogLevel
  message   String
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  agent     Agent?   @relation(fields: [agentId], references: [id])
  run       TestRun? @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@map("logs")
}

model Document {
  id           Int           @id @default(autoincrement())
  projectId    Int           @map("project_id")
  filename     String        @db.VarChar(255)
  originalName String        @db.VarChar(255)
  type         DocumentType
  fileSize     Int
  filePath     String        @map("file_path") @db.VarChar(500)
  content      String
  status       ProcessStatus @default(PENDING)
  metadata     Json?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scenarios    Scenario[]

  @@map("documents")
}

model Scenario {
  id              Int           @id @default(autoincrement())
  documentId      Int?          @map("document_id")
  suiteId         Int?          @map("suite_id")
  title           String        @db.VarChar(255)
  description     String?

  // Organizasyon alanları
  screen          String?       @db.VarChar(100) // Ekran/Sayfa adı (Homepage, Search, Login, vb.)
  category        String?       @db.VarChar(100) // Kategori (Functional, Regression, Smoke, vb.)

  steps           Json?
  expectedResult  String?       @map("expected_result")
  preconditions   String?
  testData        Json?         @map("test_data")
  priority        Priority      @default(MEDIUM)
  isAutomated     Boolean       @default(false) @map("is_automated")
  automationType  String?       @map("automation_type") @db.VarChar(50)
  scriptPath      String?       @map("script_path") @db.VarChar(500)
  scriptContent   String?       @map("script_content")
  status          ProcessStatus @default(PENDING)

  // Element keşfi ve otomasyon
  elementMappings    Json?      @map("element_mappings") // [{stepNumber, selector, xpath, elementType, confidence}]
  discoveryMetadata  Json?      @map("discovery_metadata") // {totalElements, overallConfidence, discoveredAt}
  targetUrl          String?    @map("target_url") @db.VarChar(500)
  screenshotPath     String?    @map("screenshot_path") @db.VarChar(500)

  // Son koşum bilgileri
  lastRunStatus   String?       @map("last_run_status") @db.VarChar(50)
  lastRunAt       DateTime?     @map("last_run_at")
  lastRunDuration Int?          @map("last_run_duration") // ms cinsinden
  lastRunError    String?       @map("last_run_error")

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  document        Document?     @relation(fields: [documentId], references: [id], onDelete: SetNull)
  suite           TestSuite?    @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  @@map("scenarios")
}

enum AgentType {
  ANALYST
  TEST_ARCHITECT
  ORCHESTRATOR
  SECURITY_ANALYST
  REPORT_ANALYST
}

enum AgentStatus {
  IDLE
  WORKING
  COMPLETED
  ERROR
}

enum TestType {
  UI
  API
  SECURITY
  E2E
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TestCaseStatus {
  PENDING
  ACTIVE
  DEPRECATED
}

enum RunStatus {
  PENDING
  RUNNING
  PASSED
  FAILED
  ERROR
  CANCELLED
}

enum LogLevel {
  DEBUG
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
}

enum DocumentType {
  PDF
  WORD
  EXCEL
  TXT
  MARKDOWN
}

enum ProcessStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// KULLANICI YÖNETİMİ VE LİSANS SİSTEMİ
// ============================================

model Organization {
  id             Int       @id @default(autoincrement())
  name           String    @db.VarChar(255)
  email          String?   @unique @db.VarChar(255)
  phone          String?   @db.VarChar(50)
  address        String?
  isActive       Boolean   @default(true) @map("is_active")

  // Lisans bilgileri
  licenseKey     String    @unique @map("license_key") @db.VarChar(100)
  maxUsers       Int       @default(5) @map("max_users") // Maksimum kullanıcı sayısı
  licenseExpiry  DateTime? @map("license_expiry")

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  users          User[]

  @@map("organizations")
}

model User {
  id             Int           @id @default(autoincrement())
  email          String        @unique @db.VarChar(255)
  password       String        @db.VarChar(255) // bcrypt hash
  firstName      String        @map("first_name") @db.VarChar(100)
  lastName       String        @map("last_name") @db.VarChar(100)
  role           UserRole      @default(USER)

  organizationId Int?          @map("organization_id")
  isActive       Boolean       @default(true) @map("is_active")
  lastLoginAt    DateTime?     @map("last_login_at")
  lastLoginIp    String?       @map("last_login_ip") @db.VarChar(50)

  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  auditLogs      AuditLog[]

  @@map("users")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  action     String   @db.VarChar(100) // LOGIN, LOGOUT, CREATE_PROJECT, DELETE_USER, etc.
  resource   String?  @db.VarChar(100) // project, user, test, agent, etc.
  resourceId Int?     @map("resource_id")
  details    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(50)
  userAgent  String?  @map("user_agent") @db.VarChar(500)
  createdAt  DateTime @default(now()) @map("created_at")

  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  SUPER_ADMIN  // Sistem yöneticisi - tüm yetkiler
  ADMIN        // Firma yöneticisi - kullanıcı yönetimi, proje oluştur/sil, Agent Management hariç her şey
  USER         // Normal kullanıcı - Agent Management hariç, proje oluştur/sil hariç, kullanıcı yönetimi hariç
}

// ============================================
// LAYER 3: MEMORY / RAG SYSTEM
// ============================================

model ElementMemory {
  id             Int       @id @default(autoincrement())
  projectId      Int?      @map("project_id")

  // Kullanıcı action tanımı (natural language input)
  actionText     String    @db.VarChar(500) // "Kıyaslama tabına tıkla", "Login butonuna tıkla"
  actionType     String    @db.VarChar(50)  // click, fill, navigate, select, etc.

  // Element bilgileri (başarılı olan element)
  elementTag     String    @map("element_tag") @db.VarChar(50)
  elementText    String?   @map("element_text") @db.VarChar(500)
  elementTestId  String?   @map("element_test_id") @db.VarChar(100)
  elementId      String?   @map("element_id") @db.VarChar(100)
  elementName    String?   @map("element_name") @db.VarChar(100)
  elementAriaLabel String? @map("element_aria_label") @db.VarChar(200)

  // Başarılı selector bilgisi
  selector       String    @db.VarChar(1000) // Başarılı olan selector
  locatorType    String    @map("locator_type") @db.VarChar(50) // text, testId, css, xpath, vision-coordinates

  // Context bilgileri
  urlPattern     String    @map("url_pattern") @db.VarChar(500) // Hangi URL'de bulundu
  isInModal      Boolean   @default(false) @map("is_in_modal") // Popup/modal içinde mi
  containerRole  String?   @map("container_role") @db.VarChar(50) // dialog, alert, etc.

  // Başarı metrikleri
  confidence     Int       @default(0) // AI confidence score (0-100)
  successCount   Int       @default(1) @map("success_count") // Kaç kez başarıyla kullanıldı
  lastUsedAt     DateTime  @map("last_used_at") @default(now())

  // Ek metadata
  metadata       Json?     // {screenshot, domSnapshot, visionUsed, etc.}

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([actionText]) // RAG için action text search
  @@index([projectId, urlPattern]) // Aynı proje + URL pattern için hızlı arama
  @@index([successCount]) // En başarılı pattern'leri bul
  @@map("element_memories")
}

// ============================================
// MOBILE TESTING CONFIGURATION
// ============================================

model MobileTestConfig {
  id             Int       @id @default(autoincrement())
  projectId      Int?      @map("project_id")
  scenarioId     Int?      @map("scenario_id")

  // Device configuration
  deviceName     String    @map("device_name") @db.VarChar(100) // "iPhone 15 Pro", "Samsung Galaxy S24"
  platform       String    @db.VarChar(20) // ios, android, generic
  orientation    String    @default("portrait") @db.VarChar(20) // portrait, landscape

  // Viewport settings
  viewportWidth  Int       @map("viewport_width")
  viewportHeight Int       @map("viewport_height")
  deviceScaleFactor Float  @map("device_scale_factor") @default(1)

  // User agent
  userAgent      String    @map("user_agent") @db.VarChar(500)

  // Mobile-specific test settings
  testTouchGestures Boolean @default(true) @map("test_touch_gestures") // Test tap, swipe, pinch
  testRotation   Boolean   @default(false) @map("test_rotation") // Test both orientations
  testResponsive Boolean   @default(true) @map("test_responsive") // Run responsive validation
  testPerformance Boolean  @default(false) @map("test_performance") // Mobile performance metrics

  // Network simulation
  networkThrottling String? @map("network_throttling") @db.VarChar(50) // 3G, 4G, 5G, slow-3g
  offline        Boolean   @default(false) // Test offline scenarios

  // Geolocation
  latitude       Float?
  longitude      Float?

  // Additional settings
  metadata       Json?     // Custom settings, device capabilities, etc.

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([platform])
  @@map("mobile_test_configs")
}

// ============================================
// CLOUD EXECUTION & DISTRIBUTED TESTING
// ============================================

model CloudExecution {
  id             Int       @id @default(autoincrement())
  projectId      Int       @map("project_id")
  testRunId      Int?      @map("test_run_id")

  // Cloud provider configuration
  provider       String    @db.VarChar(50) // browserstack, saucelabs, lambdatest, local
  cloudJobId     String?   @map("cloud_job_id") @db.VarChar(255) // Provider's job ID

  // Execution details
  status         String    @default("queued") @db.VarChar(50) // queued, running, completed, failed, cancelled
  priority       Int       @default(0)

  // Resource allocation
  parallelSessions Int     @default(1) @map("parallel_sessions")
  browserType    String    @db.VarChar(50) // chromium, firefox, webkit
  deviceType     String?   @db.VarChar(100) // Desktop, Mobile, Tablet, or specific device

  // Timing
  enqueuedAt     DateTime  @default(now()) @map("enqueued_at")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  durationSeconds Int?     @map("duration_seconds")

  // Results
  testsTotal     Int?      @map("tests_total")
  testsPassed    Int?      @map("tests_passed")
  testsFailed    Int?      @map("tests_failed")
  testsSkipped   Int?      @map("tests_skipped")

  // Cost tracking
  executionMinutes Float?  @map("execution_minutes")
  costPerMinute  Float?    @map("cost_per_minute")
  totalCost      Float?    @map("total_cost")

  // Links & artifacts
  videoUrl       String?   @map("video_url") @db.VarChar(500)
  logsUrl        String?   @map("logs_url") @db.VarChar(500)
  reportUrl      String?   @map("report_url") @db.VarChar(500)

  // Error handling
  errorMessage   String?   @map("error_message") @db.Text
  retries        Int       @default(0)

  // Metadata
  metadata       Json?     // Additional cloud-specific data

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([provider])
  @@index([status])
  @@index([enqueuedAt])
  @@map("cloud_executions")
}

model UsageTracking {
  id             Int       @id @default(autoincrement())
  projectId      Int       @map("project_id")
  organizationId Int?      @map("organization_id")

  // Time period
  periodStart    DateTime  @map("period_start")
  periodEnd      DateTime  @map("period_end")

  // Usage metrics
  totalExecutions Int      @default(0) @map("total_executions")
  totalMinutes   Float     @default(0) @map("total_minutes")
  totalTests     Int       @default(0) @map("total_tests")

  // Provider breakdown
  browserstackMinutes Float @default(0) @map("browserstack_minutes")
  saucelabsMinutes    Float @default(0) @map("saucelabs_minutes")
  lambdatestMinutes   Float @default(0) @map("lambdatest_minutes")
  localMinutes        Float @default(0) @map("local_minutes")

  // Cost breakdown
  totalCost      Float     @default(0) @map("total_cost")
  browserstackCost Float   @default(0) @map("browserstack_cost")
  saucelabsCost    Float   @default(0) @map("saucelabs_cost")
  lambdatestCost   Float   @default(0) @map("lambdatest_cost")

  // Limits & quotas
  monthlyLimit   Float?    @map("monthly_limit")
  warningThreshold Float?  @map("warning_threshold") // Alert at 80% usage

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@unique([projectId, periodStart])
  @@index([organizationId])
  @@index([periodStart])
  @@map("usage_tracking")
}

model PricingTier {
  id             Int       @id @default(autoincrement())
  name           String    @unique @db.VarChar(100) // Starter, Professional, Enterprise

  // Pricing
  monthlyPrice   Float     @map("monthly_price")
  yearlyPrice    Float?    @map("yearly_price")
  currency       String    @default("USD") @db.VarChar(10)

  // Limits
  maxExecutionsPerMonth Int   @map("max_executions_per_month")
  maxParallelSessions   Int   @map("max_parallel_sessions")
  maxCloudMinutes       Int   @map("max_cloud_minutes")
  maxUsers              Int   @map("max_users")
  maxProjects           Int   @map("max_projects")

  // Features
  features       Json      // Array of feature flags

  // Metadata
  description    String?   @db.Text
  isActive       Boolean   @default(true) @map("is_active")
  displayOrder   Int       @default(0) @map("display_order")

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("pricing_tiers")
}

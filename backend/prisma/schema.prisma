generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id             Int         @id @default(autoincrement())
  name           String      @db.VarChar(255)
  description    String?
  baseUrl        String?     @map("base_url") @db.VarChar(500)
  isActive       Boolean     @default(true) @map("is_active")

  // Login/Authentication bilgileri
  loginUrl       String?     @map("login_url") @db.VarChar(500)
  loginUsername  String?     @map("login_username") @db.VarChar(255)
  loginPassword  String?     @map("login_password") @db.VarChar(500) // Encrypted
  loginSelectors Json?       @map("login_selectors") // {usernameField, passwordField, submitButton}

  // Ek konfigürasyon
  customHeaders  Json?       @map("custom_headers")
  cookies        Json?
  viewportWidth  Int?        @map("viewport_width") @default(1920)
  viewportHeight Int?        @map("viewport_height") @default(1080)

  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  documents      Document[]
  testSuites     TestSuite[]

  @@map("projects")
}

model Agent {
  id          Int         @id @default(autoincrement())
  name        String      @db.VarChar(100)
  role        String      @db.VarChar(100)
  type        AgentType
  status      AgentStatus @default(IDLE)
  currentTask String?     @map("current_task")
  efficiency  Decimal     @default(0) @db.Decimal(5, 2)
  totalCost   Decimal     @default(0) @map("total_cost") @db.Decimal(10, 2)
  icon        String?     @db.VarChar(50)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  logs        Log[]
  testRuns    TestRun[]

  @@map("agents")
}

model TestSuite {
  id          Int        @id @default(autoincrement())
  projectId   Int        @map("project_id")
  name        String     @db.VarChar(255)
  description String?
  type        TestType
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  scenarios   Scenario[]
  testCases   TestCase[]
  testRuns    TestRun[]
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("test_suites")
}

model TestCase {
  id             Int            @id @default(autoincrement())
  suiteId        Int            @map("suite_id")
  name           String         @db.VarChar(255)
  description    String?
  steps          Json?
  expectedResult String?        @map("expected_result")
  priority       Priority       @default(MEDIUM)
  status         TestCaseStatus @default(PENDING)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  suite          TestSuite      @relation(fields: [suiteId], references: [id], onDelete: Cascade)
  testResults    TestResult[]

  @@map("test_cases")
}

model TestRun {
  id             Int          @id @default(autoincrement())
  suiteId        Int          @map("suite_id")
  agentId        Int?         @map("agent_id")
  status         RunStatus    @default(PENDING)
  startedAt      DateTime     @default(now()) @map("started_at")
  finishedAt     DateTime?    @map("finished_at")
  durationMs     Int?         @map("duration_ms")
  errorMessage   String?      @map("error_message")
  screenshotPath String?      @map("screenshot_path") @db.VarChar(500)
  videoPath      String?      @map("video_path") @db.VarChar(500)
  metadata       Json?
  logs           Log[]
  testResults    TestResult[]
  agent          Agent?       @relation(fields: [agentId], references: [id])
  suite          TestSuite    @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  @@map("test_runs")
}

model TestResult {
  id              Int       @id @default(autoincrement())
  runId           Int       @map("run_id")
  testCaseId      Int       @map("test_case_id")
  status          RunStatus
  actualResult    String?   @map("actual_result")
  errorDetails    Json?     @map("error_details")
  executionTimeMs Int?      @map("execution_time_ms")
  screenshotPath  String?   @map("screenshot_path") @db.VarChar(500)
  createdAt       DateTime  @default(now()) @map("created_at")
  run             TestRun   @relation(fields: [runId], references: [id], onDelete: Cascade)
  testCase        TestCase  @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@map("test_results")
}

model Log {
  id        Int      @id @default(autoincrement())
  runId     Int?     @map("run_id")
  agentId   Int?     @map("agent_id")
  level     LogLevel
  message   String
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  agent     Agent?   @relation(fields: [agentId], references: [id])
  run       TestRun? @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@map("logs")
}

model Document {
  id           Int           @id @default(autoincrement())
  projectId    Int           @map("project_id")
  filename     String        @db.VarChar(255)
  originalName String        @db.VarChar(255)
  type         DocumentType
  fileSize     Int
  filePath     String        @map("file_path") @db.VarChar(500)
  content      String
  status       ProcessStatus @default(PENDING)
  metadata     Json?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scenarios    Scenario[]

  @@map("documents")
}

model Scenario {
  id              Int           @id @default(autoincrement())
  documentId      Int?          @map("document_id")
  suiteId         Int?          @map("suite_id")
  title           String        @db.VarChar(255)
  description     String?

  // Organizasyon alanları
  screen          String?       @db.VarChar(100) // Ekran/Sayfa adı (Homepage, Search, Login, vb.)
  category        String?       @db.VarChar(100) // Kategori (Functional, Regression, Smoke, vb.)

  steps           Json?
  expectedResult  String?       @map("expected_result")
  preconditions   String?
  testData        Json?         @map("test_data")
  priority        Priority      @default(MEDIUM)
  isAutomated     Boolean       @default(false) @map("is_automated")
  automationType  String?       @map("automation_type") @db.VarChar(50)
  scriptPath      String?       @map("script_path") @db.VarChar(500)
  scriptContent   String?       @map("script_content")
  status          ProcessStatus @default(PENDING)

  // Element keşfi ve otomasyon
  elementMappings Json?         @map("element_mappings") // [{stepNumber, selector, xpath, elementType, confidence}]
  targetUrl       String?       @map("target_url") @db.VarChar(500)
  screenshotPath  String?       @map("screenshot_path") @db.VarChar(500)

  // Son koşum bilgileri
  lastRunStatus   String?       @map("last_run_status") @db.VarChar(50)
  lastRunAt       DateTime?     @map("last_run_at")
  lastRunDuration Int?          @map("last_run_duration") // ms cinsinden
  lastRunError    String?       @map("last_run_error")

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  document        Document?     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  suite           TestSuite?    @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  @@map("scenarios")
}

enum AgentType {
  ANALYST
  TEST_ARCHITECT
  ORCHESTRATOR
  SECURITY_ANALYST
}

enum AgentStatus {
  IDLE
  WORKING
  COMPLETED
  ERROR
}

enum TestType {
  UI
  API
  SECURITY
  E2E
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TestCaseStatus {
  PENDING
  ACTIVE
  DEPRECATED
}

enum RunStatus {
  PENDING
  RUNNING
  PASSED
  FAILED
  ERROR
  CANCELLED
}

enum LogLevel {
  DEBUG
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
}

enum DocumentType {
  PDF
  WORD
  EXCEL
  TXT
  MARKDOWN
}

enum ProcessStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

/**
 * Test: AyrÄ±calÄ±klÄ± Hizmetlerden YÃ¼z YÃ¼ze BankacÄ±lÄ±ÄŸa Gir ve Telefon Numara DoÄŸrulamasÄ±
 * ðŸ”§ Runtime Self-Healing Version with Smart Actions
 *
 * Generated by Nexus QA Platform
 * Date: 2025-12-24
 */

import { test, expect } from '@playwright/test';
import { smartClick, smartFill, smartWaitFor } from '../../helpers/smartActions.js';

test('AyrÄ±calÄ±klÄ± Hizmetler - Smart Actions Version', async ({ page }) => {
  console.log('\nðŸŽ¯ Test Starting: AyrÄ±calÄ±klÄ± Hizmetler Test\n');

  // Step 1: Navigate to base URL
  console.log('Step 1: Navigating to Ä°ÅŸbankasÄ±...');
  await page.goto('https://www.isbank.com.tr/online-bireysel-internet-subesi');
  await page.waitForLoadState('domcontentloaded');
  await page.screenshot({ path: 'screenshots/step1-homepage.png' }).catch(() => {});

  // Step 2: Click "AyrÄ±calÄ±klÄ± Hizmetler" with Smart Click (Vision fallback enabled!)
  console.log('Step 2: Clicking "AyrÄ±calÄ±klÄ± Hizmetler" with smartClick...');

  try {
    const clickResult = await smartClick(page, 'text=AyrÄ±calÄ±klÄ± Hizmetler', {
      retryWithVision: true,
      timeout: 10000
    });

    console.log('âœ… SmartClick Result:', clickResult);
    console.log('   Method:', clickResult.method);
    console.log('   Message:', clickResult.message);

    if (clickResult.method === 'vision-ai') {
      console.log('ðŸŽ‰ Vision AI kullanÄ±ldÄ± - gizli element bulundu!');
    } else {
      console.log('âœ“ Normal CSS selector Ã§alÄ±ÅŸtÄ±');
    }

    await page.waitForLoadState('domcontentloaded');
    await page.screenshot({ path: 'screenshots/step2-clicked.png' }).catch(() => {});

  } catch (error) {
    console.error('âŒ SmartClick failed:', error.message);

    // Hata durumunda screenshot al
    await page.screenshot({ path: 'screenshots/step2-error.png' }).catch(() => {});

    // Vision API kullanÄ±labilirse detay ver
    if (error.message.includes('Vision failed')) {
      console.log('\nâš ï¸  Vision API de baÅŸarÄ±sÄ±z oldu');
      console.log('   Muhtemelen element gerÃ§ekten bulunamadÄ± veya sayfa yapÄ±sÄ± deÄŸiÅŸti\n');
    }

    throw error;
  }

  // Step 3: Look for "YÃ¼z YÃ¼ze BankacÄ±lÄ±k" (if exists)
  console.log('Step 3: Looking for "YÃ¼z YÃ¼ze BankacÄ±lÄ±k"...');
  try {
    const yuzYuzeResult = await smartClick(page, 'text=YÃ¼z YÃ¼ze BankacÄ±lÄ±k', {
      retryWithVision: true,
      timeout: 5000
    });
    console.log('âœ“ Clicked "YÃ¼z YÃ¼ze BankacÄ±lÄ±k":', yuzYuzeResult.method);
    await page.waitForLoadState('domcontentloaded');
    await page.screenshot({ path: 'screenshots/step3-yuzyuze.png' }).catch(() => {});
  } catch (error) {
    console.log('â„¹ï¸  "YÃ¼z YÃ¼ze BankacÄ±lÄ±k" not found, skipping...');
  }

  // Step 4: Verify phone number exists on page
  console.log('Step 4: Verifying phone number "0850 724 0 724"...');
  await page.waitForTimeout(2000);

  const pageContent = await page.content();
  const phoneExists = pageContent.includes('0850 724 0 724') ||
                     pageContent.includes('0850 724 0724') ||
                     pageContent.includes('08507240724');

  console.log('Phone number found:', phoneExists);
  await page.screenshot({ path: 'screenshots/step4-verify.png' }).catch(() => {});

  // Assertion
  expect(phoneExists).toBeTruthy();

  console.log('\nâœ… Test Completed Successfully!\n');
});
